<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <script src="http://localhost/Projet_72h/public/js/main.js"></script>
    <title>Manage users</title>
</head>
<body>

    <div class="flex flex-col sm:flex-row justify-center align-start flex-nowrap min-h-screen pb-16 sm:pb-0">
        <nav id="navbar"></nav>

        <div class="w-full grid sm:ml-16 lg:ml-40 p-2 gap-2 items-start" id="users" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); grid-template-rows: min-content;"></div>
    </div>

    <script>
        function setCookie(cname, cvalue, exdays) {const d = new Date();d.setTime(d.getTime() + (exdays*24*60*60*1000));let expires = "expires="+ d.toUTCString();document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/"; }
        function getCookie(name) {function escape(s) { return s.replace(/([.*+?\^$(){}|\[\]\/\\])/g, '\\$1'); }var match = document.cookie.match(RegExp('(?:^|;\\s*)' + escape(name) + '=([^;]*)'));return match ? match[1] : null;}
        function deleteCookie(name) {document.cookie = name+'=; Max-Age=-99999999;path=/';}

        if(getCookie("token")){
            $.post("/auth", {token:getCookie("token")}, (data) => {
                if(data.status == 400){
                    location = "/login";
                }else{
                    if(data.data.isAdmin !== true) location = "/dashboard";
                    $.get(`/allUsers?token=${getCookie("token")}`, function (data){
                        if(data.status == 400 && data.data == "Auth error") location = "/login";
                        data.data.forEach(user => {
                            console.log(user);
                            let isAdminValue1 = user.isAdmin == true ? "Admin" : "Not admin";
                            let isAdminValue2 = user.isAdmin == true ? "Not admin" : "Admin";
                            $("#users").append(`<div class="border rounded border-neutral-300 p-2 flex flex-col gap-2" id="user-${user.id}"><p class="text-xl text-neutral-900">${user.username}</p><select class="isAdminSelect" onchange="changeAdminRights(this,'${user.id}')"><option value="${user.isAdmin}">${isAdminValue1}</option><option value="${!user.isAdmin}">${isAdminValue2}</option></select><button onclick="resetPassword('${user.id}')" class="focus:outline-none text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-md text-sm px-5 py-2.5">Reset password</button><button onclick="deleteUser('${user.id}')" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto">Delete user</button></div>`)
                        });
                    });
                }
            });
        }else{
            location = "/login";
        }
        function changeAdminRights(el, id){$.post("/changeAdminRights", {token:getCookie("token"), id:id, value:el.value});}
        function resetPassword(id){$.post("/resetPassword", {token:getCookie("token"), id:id})}
        function deleteUser(id){$.post("/deleteUser", {token:getCookie("token"), id:id}, function(data){if(data.status == 200) $(`#user-${id}`).remove()})}
    </script>

</body>
</html>