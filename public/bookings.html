<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <!-- <script src="http://localhost/Projet_72h/public/src/main.js"></script> -->
    <script src="http://192.168.4.234/Projet_72h/public/src/main.js"></script>
    <title>Mes réservations</title>
</head>
<body class="bg-neutral-100 dark:bg-neutral-800">

    <div class="min-h-screen">
        <div class="sticky top-0 w-full z-50">
            <nav class="dark:bg-gray-800 bg-white border-b shadow-md dark:border-gray-700"></nav>
        </div>
        <header class="dark:bg-gray-800 bg-white shadow">
            <div class="mx-auto max-w-7xl sm:py-6 py-3 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight dark:text-neutral-100 text-gray-900" id="pageName">Mes réservations</h1>
            </div>
        </header>

        <main class="min-h-full">
            <div class="mx-auto px-1 max-w-7xl py-6 sm:px-6 lg:px-8 flex flex-col justify-center items-center min-h-full">
                <!-- Page content -->
                <div class="w-full grid p-2 gap-2 items-start" id="bookings" style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); grid-template-rows: min-content;"></div>
            </div>
        </main>
        
        <footer class="bg-white dark:bg-gray-800 flex flex-col p-4 items-center sticky top-[100vh]">
            <div class="flex flex-row items-center max-w-7xl w-full">
                <img class="h-10 w-auto logo" alt="Logo">
                <!-- Socials -->
                <div class="flex flex-row gap-3 ml-6">
                    <a href="https://instagram.com" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="fill-neutral-800 dark:fill-neutral-200" viewBox="0 0 16 16"><path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"/></svg></a>
                    <a href="https://facebook.com" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="fill-neutral-800 dark:fill-neutral-200" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/></svg></a>
                    <a href="https://twitter.com" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="fill-neutral-800 dark:fill-neutral-200" viewBox="0 0 16 16"><path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z"/>
                    </svg></a>
                </div>
            </div>
            <hr class="w-full my-4 border-gray-300">
            <p class="text-gray-900 text-base font-sans font-semibold dark:text-neutral-100 w-full max-w-7xl">@2023-<span id="currentYear"></span> Angus Inc, All right reserved</p>
        </footer>
    </div>

    <!-- Delete booking modal -->
    <div class="hidden absolute top-0 left-0 z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="deleteBookingModal"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div><div class="fixed inset-0 z-10 overflow-y-auto"><div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"><div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 max-w-lg w-full"><div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="h-6 w-6 text-red-600" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-base font-semibold leading-6 text-black dark:text-neutral-100">Supprimer la réservation pour le <span id="deleteBookingRobotName"></span></h3><p class="text-gray-500 dark:text-neutral-100 text-base mt-2">Êtes vous sure de vouloir supprimer la réservation pour ce robot ?</p></div></div></div><div class="px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6"><button type="button" onclick="deleteBooking()" id="deleteBookingButton" class="bg-red-600 hover:bg-red-500inline-flex w-full justify-center rounded-md px-3 py-2 text-sm font-semibold text-white shadow-sm sm:ml-3 sm:w-auto focus:outline-none">Supprimer</button><button type="button" class="inline-flex w-full justify-center rounded-md px-3 py-2 text-sm shadow-sm font-semibold text-black dark:text-neutral-100 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto bg-white dark:bg-gray-800 dark:hover:bg-gray-700" onclick="$('#deleteBookingModal').fadeOut();">Annuler</button></div></div></div></div></div></div>

    <!-- Code modal -->
    <div class="hidden absolute top-0 left-0 z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="codeModal"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div><div class="fixed inset-0 z-10 overflow-y-auto"><div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"><div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 max-w-lg w-full"><div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="h-6 w-6 text-green-600" viewBox="0 0 16 16"><path d="M2.873 11.297V4.142H1.699L0 5.379v1.137l1.64-1.18h.06v5.961h1.174Zm3.213-5.09v-.063c0-.618.44-1.169 1.196-1.169.676 0 1.174.44 1.174 1.106 0 .624-.42 1.101-.807 1.526L4.99 10.553v.744h4.78v-.99H6.643v-.069L8.41 8.252c.65-.724 1.237-1.332 1.237-2.27C9.646 4.849 8.723 4 7.308 4c-1.573 0-2.36 1.064-2.36 2.15v.057h1.138Zm6.559 1.883h.786c.823 0 1.374.481 1.379 1.179.01.707-.55 1.216-1.421 1.21-.77-.005-1.326-.419-1.379-.953h-1.095c.042 1.053.938 1.918 2.464 1.918 1.478 0 2.642-.839 2.62-2.144-.02-1.143-.922-1.651-1.551-1.714v-.063c.535-.09 1.347-.66 1.326-1.678-.026-1.053-.933-1.855-2.359-1.845-1.5.005-2.317.88-2.348 1.898h1.116c.032-.498.498-.944 1.206-.944.703 0 1.206.435 1.206 1.07.005.64-.504 1.106-1.2 1.106h-.75v.96Z"/></svg></div><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full"><h3 class="text-base font-semibold leading-6 text-black dark:text-neutral-100">Code pour ouvrir le hangar du robot</h3> <div id="shedCodeDiv"></div> </div></div></div><div class="px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6"><button type="button" class="mt-3 inline-flex w-full justify-center rounded-md px-3 py-2 text-sm shadow-sm font-semibold text-black dark:text-neutral-100 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto bg-white dark:bg-gray-800 dark:hover:bg-gray-700" onclick="$('#codeModal').fadeOut();">OK</button></div></div></div></div></div></div>

    <style>td {text-align: center;}</style>

    <script>
        function setCookie(cname, cvalue, exdays) {const d = new Date();d.setTime(d.getTime() + (exdays*24*60*60*1000));let expires = "expires="+ d.toUTCString();document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/"; }function getCookie(name) {function escape(s) { return s.replace(/([.*+?\^$(){}|\[\]\/\\])/g, '\\$1'); }var match = document.cookie.match(RegExp('(?:^|;\\s*)' + escape(name) + '=([^;]*)'));return match ? match[1] : null;}function deleteCookie(name) {document.cookie = name+'=; Max-Age=-99999999;path=/';}

        $.get("/navbar", (data) => {$("nav").html(data);if(getCookie("token")) $(".notLogged").remove(); else $(".logged").remove();});

        if(getCookie("token")){
            $.post("/auth", {token:getCookie("token")}, (data) => {
                if(data.status == 400){
                    deleteCookie("token");
                    location.reload();
                }else{
                    $.get(`/myBookings?token=${getCookie("token")}`, function(bookings){
                        if(bookings.status == 200){
                            bookings.data.forEach((booking, index) => {
                                $.get(`/robotInfo/${booking.data.robot}`, function(data){
                                    if(data.status == 200){
                                        $("#bookings").append(`<div class="bg-white dark:bg-gray-800 rounded p-3 flex flex-col gap-2 dark:text-neutral-100 text-gray-900" id="booking-${booking.id}" data-index="${index}" data-timestamp="${new Date(booking.data.date).getTime()}"><p>Vous avez réserver <b>${data.data.name}</b> pour le ${new Date(booking.data.date).toLocaleDateString("fr-FR")}</p><div class="w-full flex gap-2 flex-row justify-between"><button type="button" onclick="deleteBookingModal('${booking.id}', '${data.data.name}')" class="focus:outline-none text-white bg-red-600 hover:bg-red-500 font-medium rounded-lg text-sm px-2 py-2" ><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button><button onclick="showCodeModal('${booking.data.date}', '${booking.id}', '${data.data.name}')"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg></button>`);
                                    }
                                    let items = $("#bookings").children().sort(function(a, b) {let vA = parseInt($(a).attr("data-timestamp"));let vB = parseInt($(b).attr("data-timestamp"));return (vA < vB) ? -1 : (vA > vB) ? 1 : 0;});
                                    $("#bookings").append(items);
                                });
                            });
                        }
                    });
                }
            });
        }else location = "/login?redirect=bookings";

        function deleteBookingModal(bookingId, robotName){$("#deleteBookingRobotName").text(robotName);$("#deleteBookingModal").fadeIn();$("#deleteBookingButton").attr("data-robot-id", bookingId);}
        function showCodeModal(date, id, robotName){
            $("#shedCodeDiv").empty()
            if(new Date(date).toLocaleDateString() == new Date().toLocaleDateString()){$(`#shedCodeDiv`).append(`<p class="text-sm text-neutral-500 mt-2">Le code pour ouvrir le hangar du robot : </p><div class="flex flex-row gap-1 w-full items-center sm:justify-start justify-center"><p class="h-full bg-neutral-400 blur-sm rounded w-fit text-2xl p-1" id="codeP-${id}">0000</p><button onclick="toggleCode('${id}', this)" class="inline-flex w-full justify-center rounded-md bg-neutral-200 px-3 py-2 text-sm font-semibold text-neutral-500 shadow-sm hover:bg-neutral-300 w-fit">Voir le code</button></div>`);}else{let diffDays = Math.ceil((Math.abs(new Date(date) - new Date())) / (1000 * 60 * 60 * 24));$(`#shedCodeDiv`).append(`<p class="text-sm text-neutral-500">Dans <b>${diffDays}</b> ${diffDays == 1 ? "jour" : "jours"}, vous pourrez acceder au code pour <b>${robotName}</b>. </p>`);}

            $.get(`/shedCode/${id}?token=${getCookie("token")}`,function(data){if(data.status == 200)$(`#codeP-${id}`).text(data.data);});
            $("#codeModal").fadeIn()
        }
        function toggleCode(id, button){$(`#codeP-${id}`).toggleClass("blur-sm");if($(button).text() == "Voir le code")$(button).text("Cacher le code");else $(button).text("Voir le code"); }
        function deleteBooking(){let id = $("#deleteBookingButton").attr("data-robot-id");$.post(`/deleteBooking`, {token:getCookie("token"), id:id}, function(data){if(data.status == 200){$(`#booking-${id}`).remove();$(`#deleteBookingModal`).fadeOut();new Vibration([200, 50, 200]).vibrate();}});}
    </script>
    
</body>
</html>