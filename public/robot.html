<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <script src="http://localhost/Projet_IT/public/js/main.js"></script>
    <title>Robot</title>
</head>
<body>


    <div class="flex flex-col sm:flex-row align-start flex-nowrap min-h-screen pb-16 sm:pb-0">
        <nav id="navbar"></nav>

        <div class="w-full flex flex-col items-center sm:ml-16 lg:ml-40 p-2">
            <div class="border rounded border-gray-300 p-2 min-w-50 w-full" id="robot"></div>
        </div>
    </div>    

    <style>td {text-align: center;}</style>

    <script>
        function setCookie(cname, cvalue, exdays) {const d = new Date();d.setTime(d.getTime() + (exdays*24*60*60*1000));let expires = "expires="+ d.toUTCString();document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/"; }function getCookie(name) {function escape(s) { return s.replace(/([.*+?\^$(){}|\[\]\/\\])/g, '\\$1'); }var match = document.cookie.match(RegExp('(?:^|;\\s*)' + escape(name) + '=([^;]*)'));return match ? match[1] : null;}function deleteCookie(name) {document.cookie = name+'=; Max-Age=-99999999;path=/';}

        if(getCookie("token")){
            $.post("/auth", {token:getCookie("token")}, (data) => {
                if(data.status == 400){
                    deleteCookie("token");
                    location.reload();
                }else{
                    let robotId = window.location.href.split("/");
                    robotId = robotId[robotId.length - 1];
                    $.get("/availableRobots", function(robots){
                        if(robots.status == 200){
                            $.get(`/bookings/${robotId}`, function(bookings){
                                if(bookings.status == 200){
                                    let robot = robots.data.filter(robot => {return robot.id == robotId})[0];
                                    robot.reservations = bookings.data;
                                    let today = new Date();
                                    let availability = robot.reservations.filter(reservation => {return new Date(reservation.date) == today.toLocaleDateString("en-EN")}).length == 0 ? "available" : "not available";
                                    let robotName = robot.data.name;
                                    robotName = robotName.charAt(0).toUpperCase() + robotName.slice(1);
                                    currentMonth = today.getMonth();
                                    currentYear = today.getFullYear();
                                    months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                    $("#robot").append(`<p>${robotName} is ${availability} today. <button type="button" class="focus:outline-none text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5" onclick="$('#${robot.id}').toggleClass('hidden')">Book it</button></p><div class="hidden relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="${robot.id}"><div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity sm:ml-16 lg:ml-40"></div><div class="fixed inset-0 z-10 overflow-y-auto sm:ml-16 lg:ml-40 sm:mb-0 mb-16"><div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"><div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 w-full sm:max-w-lg"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Book <b>${robotName}</b></h3><div class="mt-2"><p class="text-sm text-gray-500">When would you like to book this robot ?</p><div><table class="border border-gray-300"><thead class="border-0 border-b border-gray-300"><tr><th>Mon</th><th>Tues</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr></thead><tbody id="${robot.id}-calender"></tbody></table><div class="w-full flex flex-row justify-between gap-2 mt-2 items-center"><button class="focus:outline-none text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 w-max" id="previous"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/></svg></button><h3 class="card-header" id="${robot.id}-monthAndYear"></h3><button class="focus:outline-none text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 w-auto" id="next"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/></svg></button></div><p id="dateOfBooking" class="mt-2"></p></div></div></div></div></div><div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6"><button type="button" disabled id="bookButton" class="inline-flex w-full justify-center rounded-md bg-green-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700 sm:ml-3 sm:w-auto disabled:bg-neutral-500">Book</button><button type="button" onclick="$('#${robot.id}').addClass('hidden')"  class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button></div></div></div></div></div>`);
                                    $("#next").click(()=>{currentYear = (currentMonth === 11) ? currentYear + 1 : currentYear;currentMonth = (currentMonth + 1) % 12;showCalendar(currentMonth, currentYear);})
                                    $("#previous").click(()=>{currentYear = (currentMonth === 0) ? currentYear - 1 : currentYear;currentMonth = (currentMonth === 0) ? 11 : currentMonth - 1;showCalendar(currentMonth, currentYear);})
                                    
                                    showCalendar(currentMonth, currentYear);
                                    function showCalendar(month, year) {
                                        let today = new Date();
                                        let firstDay = (new Date(year, month)).getDay();
                                        tbl = document.getElementById(`${robot.id}-calender`);
                                        tbl.innerHTML = "";
                                        document.getElementById(`${robot.id}-monthAndYear`).innerHTML = months[month] + " " + year;
                                        let date = 1;
                                        for (let i = 0; i < 6; i++) {
                                            let row = document.createElement("tr");
                                            for (let j = 0; j < 7; j++) {
                                                if (i === 0 && j < firstDay) {
                                                    cell = document.createElement("td");
                                                    cellText = document.createTextNode("");
                                                    cell.appendChild(cellText);
                                                    row.appendChild(cell);
                                                }
                                                else if (date > daysInMonth(month, year)) {
                                                    break;
                                                }
                                                else {
                                                    cell = document.createElement("td");
                                                    cell.classList.add("border");
                                                    cell.classList.add("border-gray-300");
                                                    cellText = document.createTextNode(date);
                                                    let yesterday = new Date();
                                                    yesterday.setDate(today.getDate() - 1);
                                                    if(new Date(`${month+1}/${date}/${year}`) <= yesterday){
                                                        cell.classList.add("bg-gray-300");
                                                        cell.appendChild(cellText);
                                                    }else if(robot.reservations.filter(reservation => {return reservation.date == new Date(`${month+1}/${date}/${year}`).toLocaleDateString("en-EN")}).length !== 0){
                                                        cell.classList.add("bg-gray-300");
                                                        cell.appendChild(cellText);
                                                    }else {
                                                        button = document.createElement("button");
                                                        button.classList.add("w-full");
                                                        button.classList.add("bookButton");
                                                        cell.appendChild(button);
                                                        button.appendChild(cellText);
                                                    }
                                                    row.appendChild(cell);
                                                    date++;
                                                }
                                            }
                                            tbl.appendChild(row);
                                        }
                                        $(".bookButton").click(function(){
                                            $("#bookButton").removeAttr("disabled");
                                            $("td > button").each(function(){$( this ).removeClass("bg-indigo-600");});
                                            $( this ).toggleClass("bg-indigo-600");
                                            $("#dateOfBooking").text(`Book ${robotName} for the ${$(this).text()} ${months[month]} ${year} ?`);
                                            date = $(this).text();
                                        });
                                        $("#bookButton").click(function(){
                                            let bookingDate = new Date(`${month+1}/${date}/${year}`).toLocaleDateString("en-EN");
                                            $.post("/book", {token:getCookie("token"), robot:robotId, date:bookingDate}, function(data){
                                                if(data.status == 200){
                                                    location = `/bookings`;
                                                }
                                            })
                                        });
                                    }
                                    function daysInMonth(iMonth, iYear) {return 32 - new Date(iYear, iMonth, 32).getDate();}
                                }
                            })
                        }
                    })
                }
            });
        }
    </script>
    
</body>
</html>